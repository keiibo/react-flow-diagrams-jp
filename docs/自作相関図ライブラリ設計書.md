# 自作相関図ライブラリ設計書

## 1. プロジェクト概要

### 1.1 背景・目的

現在のキャラクター相関図機能では React Flow を使用していますが、有償ライセンス以外では右下にクレジット表示が必須となっています。この問題を解決し、より柔軟なカスタマイズを可能にするため、独自の相関図ライブラリを開発します。

### 1.2 目標

- React Flow のライセンス問題解決
- 現在の機能を 100%維持
- パフォーマンスの向上
- カスタマイズ性の向上
- 将来的な機能拡張の基盤構築

## 2. 現在の機能分析

### 2.1 React Flow で使用中の機能

```
✅ ノードの配置・ドラッグ移動
✅ エッジ（関係線）の描画
✅ ベジェ曲線による滑らかな接続線
✅ ハンドルによる接続機能
✅ ズーム・パン操作
⬜ ノード・エッジの選択
⬜ 選択要素の削除
⬜ ミニマップ表示
✅ コントロールボタン（ズームイン/アウト、リセット）
⬜ ツールバー連携
⬜ キーボードショートカット対応
✅ グリッド背景表示
```

### 2.2 現在の課題

- ライセンス制約（クレジット表示）
- カスタマイズの限界
- バンドルサイズの増加
- 不要機能の含有

## 3. 技術要件

### 3.1 機能要件

#### 必須機能

| 機能           | 詳細                             | 優先度 |
| -------------- | -------------------------------- | ------ |
| ノード描画     | キャラクターアイコンと名前表示   | 高     |
| ノードドラッグ | マウスによる位置変更             | 高     |
| エッジ描画     | ノード間の関係線表示             | 高     |
| エッジラベル   | 関係性テキストの表示・編集機能   | 高     |
| ズーム操作     | マウスホイール・ボタンによる拡縮 | 高     |
| パン操作       | ドラッグによるキャンバス移動     | 高     |
| 選択機能       | ノード・エッジの選択状態管理     | 高     |
| 削除機能       | 選択要素の削除                   | 高     |
| 接続機能       | ハンドルによるノード間接続       | 高     |
| ノード形状     | 円形・正方形・長方形・角丸対応   | 中     |

#### 追加機能

| 機能           | 詳細                             | 優先度 |
| -------------- | -------------------------------- | ------ |
| ミニマップ     | 全体表示とナビゲーション         | 中     |
| コントロール   | ズーム・フィットボタン           | 中     |
| グリッド表示   | 背景グリッドパターン             | 高     |
| スナップ機能   | グリッドへの自動吸着             | 低     |
| 4 方向ハンドル | 上下左右すべてのハンドル接続対応 | 高     |

### 3.2 非機能要件

#### パフォーマンス

- 100 ノード以上でのスムーズな動作
- 60fps 以上のアニメーション
- メモリ使用量の最適化

#### 互換性

- React 18+対応
- TypeScript 完全対応
- モダンブラウザ対応（Chrome, Firefox, Safari, Edge）

#### 保守性

- モジュラー設計
- テストカバレッジ 80%以上
- ドキュメント完備

## 4. アーキテクチャ設計

### 4.1 コンポーネント構成

```
CustomCharacterMap/
├── core/              # コア機能
│   ├── Canvas         # メインキャンバス
│   ├── Viewport       # ズーム・パン制御
│   ├── Selection      # 選択状態管理
│   └── Connection     # 接続管理
├── components/        # UIコンポーネント
│   ├── Node           # ノードコンポーネント
│   ├── Edge           # エッジコンポーネント
│   ├── Handle         # 接続ハンドル
│   ├── MiniMap        # ミニマップ
│   └── Controls       # 操作コントロール
├── hooks/             # カスタムフック
│   ├── useCanvas      # キャンバス操作
│   ├── useViewport    # ビューポート制御
│   ├── useSelection   # 選択制御
│   └── useConnection  # 接続制御
└── utils/             # ユーティリティ
    ├── geometry       # 座標計算
    ├── bezier         # ベジェ曲線
    └── collision      # 衝突判定
```

### 4.2 データ構造

```typescript
// 基本データ型
type Node = {
  id: string;
  position: { x: number; y: number };
  data: CharacterData;
  selected?: boolean;
};

type Edge = {
  id: string;
  source: string;
  target: string;
  data: RelationshipData;
  selected?: boolean;
};

type Viewport = {
  x: number;
  y: number;
  zoom: number;
};
```

### 4.3 レンダリング方式

- **SVG + foreignObject**: ノード内で React コンポーネント使用可能
- **Canvas**: 大量要素時の高速描画（将来対応）
- **ハイブリッド**: 用途に応じた使い分け

## 5. 開発計画

### 5.1 開発フェーズ

#### Phase 1: 基盤構築（2 週間）

- [x] プロジェクト構成
- [x] TypeScript 型定義
- [x] 基本キャンバス実装
- [x] ビューポート制御

#### Phase 2: コア機能（3 週間）

- [x] ノード描画・ドラッグ
- [x] エッジ描画
- [ ] 選択機能
- [x] ズーム・パン操作

#### Phase 3: 接続機能（2 週間）

- [x] ハンドル実装
- [x] 接続線描画
- [x] ベジェ曲線計算
- [x] 接続状態管理

#### Phase 4: 統合・最適化（1 週間）

- [ ] React Flow API 互換層
- [ ] パフォーマンス最適化
- [ ] テスト実装
- [ ] ドキュメント作成

### 5.2 移行計画

#### 段階的移行

1. **基本機能**: 静的表示から開始
2. **操作機能**: ドラッグ・選択を追加
3. **接続機能**: ハンドル・エッジを実装
4. **完全移行**: React Flow を置換

#### リスク軽減

- 機能単位での段階的実装
- 既存機能との並行運用期間
- フォールバック機能の準備

## 6. 品質保証

### 6.1 テスト戦略

- **単体テスト**: Jest + React Testing Library
- **統合テスト**: Playwright
- **視覚回帰テスト**: Chromatic
- **パフォーマンステスト**: Lighthouse

### 6.2 品質指標

- テストカバレッジ: 80%以上
- パフォーマンススコア: 90 以上
- アクセシビリティスコア: 90 以上
- バンドルサイズ: React Flow 比 50%削減

## 7. 運用・保守

### 7.1 監視項目

- パフォーマンスメトリクス
- エラー率
- ユーザビリティ指標

### 7.2 保守計画

- 月次パフォーマンスレビュー
- 四半期機能追加
- セキュリティアップデート対応

## 8. 今後の拡張性

### 8.1 将来追加予定機能

- アニメーション効果
- レイアウトアルゴリズム（自動配置）
- エクスポート機能（PNG, SVG, PDF）
- 協調編集機能
- モバイル対応

### 8.2 拡張アーキテクチャ

- プラグインシステム
- テーマシステム
- 外部ライブラリ連携 API

## 9. まとめ

本プロジェクトにより、React Flow のライセンス制約を解決し、より柔軟で高性能な相関図ライブラリを実現します。段階的な開発・移行により、リスクを最小化しながら確実な成果を目指します。

## 10. 実装済み機能の詳細

### 10.1 完成済み機能（2025-06-22 時点）

#### コア機能

- ✅ **ノードシステム**

  - 基本的なノード描画
  - ドラッグ＆ドロップによる位置変更
  - 複数形状対応（rectangle, rounded, square, circle）
  - リアルタイム位置更新

- ✅ **エッジシステム**

  - ベジェ曲線による滑らかな接続線
  - 矢印ヘッド表示
  - ソース・ターゲットハンドル対応
  - エッジラベル表示・編集機能（ダブルクリック編集）

- ✅ **接続システム**

  - 4 方向ハンドル（上下左右）
  - 任意のハンドル間接続
  - 接続プレビュー表示
  - 同一ノードへの接続防止

- ✅ **ビューポート制御**

  - マウスホイール + Cmd（Ctrl）による拡大縮小
  - ホイールによる縦スクロール
  - Shift + ホイールによる横スクロール
  - ドラッグによるパン操作
  - ズームイン・アウトボタン
  - リセットボタン

- ✅ **基本 UI**
  - グリッド背景
  - コントロールパネル
  - ステータス表示（ノード数、エッジ数、ズーム率）

### 10.2 未実装機能

- ⬜ ノード・エッジの選択機能
- ⬜ 選択要素の削除機能
- ⬜ ミニマップ
- ⬜ フィットビュー機能
- ⬜ エッジラベル編集
- ⬜ キーボードショートカット
- ⬜ スナップ機能

### 10.3 技術的成果

- TypeScript 完全対応
- React 18 互換
- モジュラーな設計（hooks、components、utils 分離）
- Storybook によるコンポーネントドキュメント

### 10.4 進捗サマリー

#### 開発フェーズ別進捗

- Phase 1（基盤構築）: **100%完了** ✅
- Phase 2（コア機能）: **75%完了**（選択機能のみ未実装）
- Phase 3（接続機能）: **100%完了** ✅
- Phase 4（統合・最適化）: **0%**（未着手）

#### 全体進捗

- 必須機能: **80%完了**（8/10 機能実装済み）
- 追加機能: **40%完了**（2/5 機能実装済み）
- **総合進捗率: 約 65%**

現在のライブラリは基本的な相関図作成には十分な機能を備えており、React Flow のライセンス問題を解決する最小限の目標は達成しています。

---

**作成日**: 2025-06-21  
**更新日**: 2025-06-22  
**バージョン**: 1.1.0
